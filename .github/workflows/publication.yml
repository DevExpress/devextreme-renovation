name: Publication
on: [push]

jobs:

  version-bump:
    name: Detect version bump
    runs-on: ubuntu-latest
    outputs:
      changed: ${{ steps.detection.outputs.changed }}
      version: ${{ steps.detection.outputs.version }}

    steps:

      - name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 2

      - name: Detect Bump
        id: detection
        uses: ./.github/actions/detect-version-bump

  prebuild: 
    name: Prebuild
    runs-on: ubuntu-latest
    needs: [ version-bump ]

    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - name: Run npm install
        run: npm install --no-audit --no-fund --ignore-scripts

      - name: Run bootstrap
        run: npm run bootstrap:ci

      - name: Build
        run: npm run build

      - name: Test
        run: npm run test

      - name: Pack
        run: npm run pack

      - uses: actions/upload-artifact@master
        with:
          name: devextreme-generator-artifacts
          path: ./packages/**/*.tgz

  publishing:
    name: Publish
    runs-on: ubuntu-latest
    needs: [ prebuild ]

    strategy:
      matrix:
        PACKAGE: [
          core-generator,
          angular-generator,
          vue-generator,
          react-generator,
          preact-generator,
          inferno-generator,
          build-helpers,
          declarations,
          vdom,
        ]

    steps:

      - name: Checkout
        uses: actions/checkout@v2

      - uses: actions/download-artifact@master
        with:
          name: devextreme-generator-artifacts

      - name: Publish ${{ matrix.PACKAGE }}
        run: npm publish ./packages/${{ matrix.PACKAGE }}/*.tgz --dry-run
        env:
          PACKAGE: ${{ matrix.PACKAGE }}
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}